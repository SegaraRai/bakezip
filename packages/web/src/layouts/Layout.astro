---
import { ClientRouter } from "astro:transitions";
import { pwaAssetsHead } from "virtual:pwa-assets/head";
import { pwaInfo } from "virtual:pwa-info";
import { commitHash } from "../buildInfo.macro.ts" with { type: "macro" };
import LanguageSelector from "../components/LanguageSelector.svelte";
import LanguageSuggestion from "../components/LanguageSuggestion.svelte";
import ThemeSelector from "../components/ThemeSelector.svelte";
import {
  LOCALES,
  createI18n,
  getLocalizedPath,
  type Locale,
} from "../lib/i18n";
import {
  DEFAULT_THEME,
  FALLBACK_THEME,
  LSKEY_THEME,
  THEME_MAP,
} from "../lib/theme";

import "../global.css";

interface Props {
  locale: Locale;
  rootClass?: any;
  bodyClass?: any;
  mainClass?: any;
  title?: string;
  noShare?: boolean;
  noTranslate?: boolean;
}

const {
  locale,
  title = "BakeZip",
  noShare = false,
  noTranslate = false,
} = Astro.props;
const m = createI18n(locale);

const socialImage = new URL(`/social-${locale}.png`, Astro.url);
const description = m.seo_page_description();

const alternateLinks = LOCALES.map((l) => ({
  href: new URL(getLocalizedPath(Astro.url.pathname, l.code), Astro.url),
  hreflang: l.code,
}));
---

<!doctype html>
<html lang={locale} class="bg-base-300" class:list={Astro.props.rootClass}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:image" content={socialImage} />
    <meta property="og:description" content={description} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content={socialImage} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {
      pwaAssetsHead.themeColor && (
        <meta name="theme-color" content={pwaAssetsHead.themeColor.content} />
      )
    }
    <link rel="canonical" href={Astro.url} />
    {
      alternateLinks.map((link) => (
        <link rel="alternate" hreflang={link.hreflang} href={link.href} />
      ))
    }
    {pwaAssetsHead.links.map((link) => <link {...link} />)}
    {pwaInfo && <Fragment set:html={pwaInfo.webManifest.linkTag} />}
    <title>{title}</title>
    <ClientRouter />
    <slot name="script" />
    <script
      is:inline
      define:vars={{
        defaultTheme: DEFAULT_THEME,
        fallbackTheme: FALLBACK_THEME,
        lsKey: LSKEY_THEME,
        themeMap: THEME_MAP,
      }}
    >
      let theme = fallbackTheme;
      try {
        theme = localStorage.getItem(lsKey) ?? defaultTheme;
        if (theme === "system") {
          theme = window.matchMedia("(prefers-color-scheme:dark)").matches
            ? "dark"
            : "light";
        }
        theme = themeMap[theme] ?? themeMap[fallbackTheme];
      } catch {}
      document.documentElement.dataset.theme = theme;

      document.addEventListener("astro:before-swap", (event) => {
        for (const key of ["lastLocale", "theme"]) {
          if (document.documentElement.dataset[key]) {
            event.newDocument.documentElement.dataset[key] =
              document.documentElement.dataset[key];
          }
        }
      });
    </script>
    {/* Commit Hash */}
    <Fragment set:html={`<!--#${commitHash}-->`} />
  </head>
  <body class:list={Astro.props.bodyClass}>
    <a
      href="#main-content"
      class="not-focus:sr-only focus:absolute focus:top-4 focus:left-4 focus:z-100 btn btn-primary btn-xl"
      >{m.skip_to_main_content()}</a
    >
    <header
      class="fixed top-0 right-0 px-6 py-4 flex gap-2 justify-end z-50 not-lg:w-full bg-base-300/75 backdrop-blur-sm lg:rounded-bl-md"
    >
      <a
        transition:name="github-repo"
        title={m.github_repo()}
        href="https://github.com/SegaraRai/bakezip"
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-sm btn-ghost gap-2"
      >
        <span class="icon-[mdi--github] text-lg" aria-hidden="true"></span>
        <span class="max-sm:sr-only">{m.github_repo()}</span>
      </a>
      {
        !noShare && (
          <a
            transition:name="share-button"
            title={m.share_on_x()}
            href={`https://x.com/intent/tweet?text=${encodeURIComponent(m.share_text({ url: Astro.url }))}`}
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-sm btn-ghost gap-2"
          >
            <span
              class="icon-[mdi--share-variant] text-lg"
              aria-hidden="true"
            />
            <span class="max-sm:sr-only">{m.share_on_x()}</span>
          </a>
        )
      }
      {
        !noTranslate && (
          <LanguageSelector
            client:idle
            transition:persist
            currentLocale={locale}
            pathname={Astro.url.pathname}
          />
        )
      }
      <ThemeSelector
        client:idle={{ timeout: 500 }}
        transition:persist
        locale={locale}
      />
    </header>
    {
      !noTranslate && (
        <LanguageSuggestion
          client:load
          transition:persist
          currentLocale={locale}
          pathname={Astro.url.pathname}
        />
      )
    }
    <main id="main-content" class:list={Astro.props.mainClass ?? "contents"}>
      {/* Top Padding For Fixed Header */}
      <div class="w-full h-18 lg:hidden"></div>
      <slot />
      {/* Bottom Padding For Language Suggestion Toast */}
      <div class="w-full h-18"></div>
    </main>
  </body>
</html>
